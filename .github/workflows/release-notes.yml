name: Generate Consolidated Release Notes

on:
  workflow_call:

jobs:
  verify_workflow:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - id: check
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" || "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

  calculate_diffs:
    needs: verify_workflow
    if: needs.verify_workflow.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_tag:
          - "8.1-alpine3.19"
          - "8.2-alpine3.19"
          - "8.3-alpine3.19"
          - "8.1-alpine3.20"
          - "8.2-alpine3.20"
          - "8.3-alpine3.20"
          - "8.4-alpine3.20"
          - "8.2-alpine3.21"
          - "8.3-alpine3.21"
          - "8.4-alpine3.21"
          - "8.2-alpine3.22"
          - "8.3-alpine3.22"
          - "8.4-alpine3.22"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üîé Find Last & Previous Job IDs for ${{ matrix.image_tag }}
        id: find_jobs
        run: |
          # Get the last two successful runs
          RUN_IDS=$(gh run list --workflow="ECR vulnerability detection" --status="success" --limit=20 --json databaseId -q '.[].databaseId')
          LATEST_JOB_ID=""
          PREVIOUS_JOB_ID=""
          for RUN_ID in $RUN_IDS; do
            JOB_ID=$(gh api "repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs" --jq ".jobs[] | select(.name | contains(\"${{ matrix.image_tag }}\") and .conclusion == \"success\") | .id" || echo "")
            if [[ -n "$JOB_ID" ]]; then
              if [[ -z "$LATEST_JOB_ID" ]]; then LATEST_JOB_ID=$JOB_ID;
              elif [[ -z "$PREVIOUS_JOB_ID" ]]; then PREVIOUS_JOB_ID=$JOB_ID; break; fi
            fi
          done
          echo "Found latest job: $LATEST_JOB_ID"
          echo "Found previous job: $PREVIOUS_JOB_ID"
          echo "latest_job_id=${LATEST_JOB_ID}" >> $GITHUB_OUTPUT
          echo "previous_job_id=${PREVIOUS_JOB_ID}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì• Fetch and Parse Logs for ${{ matrix.image_tag }}
        run: |
          if [[ -n "${{ steps.find_jobs.outputs.latest_job_id }}" ]]; then
            gh run view --job ${{ steps.find_jobs.outputs.latest_job_id }} --log > latest_raw.log
            awk "/cat <<'JSON'/{flag=1; next} /JSON/{flag=0} flag" latest_raw.log > latest-scan.json
          fi
          if [[ -n "${{ steps.find_jobs.outputs.previous_job_id }}" ]]; then
            gh run view --job ${{ steps.find_jobs.outputs.previous_job_id }} --log > previous_raw.log
            awk "/cat <<'JSON'/{flag=1; next} /JSON/{flag=0} flag" previous_raw.log > previous-scan.json
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîÑ Compare Scans for ${{ matrix.image_tag }}
        id: compare
        run: |
          PREVIOUS_SCAN_FILE="previous-scan.json"
          CURRENT_SCAN_FILE="latest-scan.json"
          if [[ ! -f "$PREVIOUS_SCAN_FILE" ]]; then touch "$PREVIOUS_SCAN_FILE"; fi
          if [[ ! -f "$CURRENT_SCAN_FILE" ]]; then touch "$CURRENT_SCAN_FILE"; fi

          # Validate the JSON in each file. If invalid, create a valid placeholder.
          if ! jq . "$PREVIOUS_SCAN_FILE" >/dev/null 2>&1; then
            echo "Warning: Previous scan file was invalid. Creating empty placeholder."
            echo '{ "imageScanFindings": { "findings": [] } }' > "$PREVIOUS_SCAN_FILE"
          fi
          if ! jq . "$CURRENT_SCAN_FILE" >/dev/null 2>&1; then
            echo "Warning: Current scan file was invalid. Creating empty placeholder."
            echo '{ "imageScanFindings": { "findings": [] } }' > "$CURRENT_SCAN_FILE"
          fi
          
          FIXED_VULNS=$(jq -r --slurpfile current "$CURRENT_SCAN_FILE" \
            '.imageScanFindings.findings[] | select(.name as $cve | ($current[0].imageScanFindings.findings | map(.name) | index($cve) | not)) | "- **\(.name)**: \(.description)"' \
            "$PREVIOUS_SCAN_FILE")
            
          if [[ -z "$FIXED_VULNS" ]]; then
            echo "- No CVEs fixed in this release." > fixed_vulns.txt
          else
            echo "$FIXED_VULNS" > fixed_vulns.txt
          fi

      - name: üì§ Upload Diff for ${{ matrix.image_tag }}
        uses: actions/upload-artifact@v4
        with:
          name: diff-${{ matrix.image_tag }}
          path: fixed_vulns.txt
            
  generate_notes:
    needs: calculate_diffs
    runs-on: ubuntu-latest
    steps:
      - name: üì• Download All CVE Diffs
        uses: actions/download-artifact@v4
        with:
          path: ./all-diffs

      - name: üì£ Get Merged PR Info
        id: pr-info
        uses: actions-ecosystem/action-get-merged-pull-request@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úçÔ∏è Extract PR Sections
        id: extract
        run: |
          PR_BODY='${{ steps.pr-info.outputs.body }}'
          IMPROVEMENTS=$(echo "$PR_BODY" | awk '/### Improvements/{flag=1;next}/###/{flag=0}flag')
          echo "improvements<<EOF" >> $GITHUB_OUTPUT
          echo "$IMPROVEMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìú Assemble and Display Release Notes
        run: |
          RELEASE_DATE=$(date +'%Y%m%d')
          PUBLISH_DATE=$(date +'%Y-%m-%d')
          
          SECURITY_FIXES_BODY=""
          for dir in ./all-diffs/*/; do
            IMAGE_TAG=$(basename "$dir")
            IMAGE_TAG=${IMAGE_TAG#diff-}
            FIXED_CVES=$(cat "${dir}/fixed_vulns.txt")
            SECURITY_FIXES_BODY+=$(printf '\n### spryker/php:%s\n%s\n' "$IMAGE_TAG" "$FIXED_CVES")
          done

          cat << EOF > release-notes.md
          ---
          title: Release notes ${RELEASE_DATE}.0
          description: This document describes the changes that have been recently released.
          last_updated: ${PUBLISH_DATE}
          publish_date: "${PUBLISH_DATE}"
          ---
          This document describes the changes that have been recently released.
          For additional support with this content, contact our support.  
          If you found a new security vulnerability, contact us at **security@spryker.com**.

          ## Changelog
          ### Improvements
          ${{ steps.extract.outputs.improvements }}

          ---
          ## Security fixes by image
          ${SECURITY_FIXES_BODY}
          EOF

          echo "::group::üìú Consolidated Release Notes"
          cat release-notes.md
          echo "::endgroup::"