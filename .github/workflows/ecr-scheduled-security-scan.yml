name: ECR vulnerability detection

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 10 * * *'
  push:
    branches:
      - feature/sc-23564/master-security-scan-on-latest-images

jobs:
  vulnerability-detection:
    runs-on: ubuntu-latest
    env:
      PHP_VARIANT: cli
    strategy:
      fail-fast: false
      matrix:
        include:
          ## Alpine
          ### Alpine 3.19
          - image: "alpine/3.19/8.1/Dockerfile"
            tags: "8.1-alpine3.19"
            platforms: "linux/amd64"
          - image: "alpine/3.19/8.2/Dockerfile"
            tags: "8.2-alpine3.19"
            platforms: "linux/amd64"
          - image: "alpine/3.19/8.3/Dockerfile"
            tags: "8.3-alpine3.19"
            platforms: "linux/amd64"

          ### Alpine 3.20
          - image: "alpine/3.20/8.1/Dockerfile"
            tags: "8.1-alpine3.20"
            platforms: "linux/amd64"
          - image: "alpine/3.20/8.2/Dockerfile"
            tags: "8.2-alpine3.20"
            platforms: "linux/amd64"
          - image: "alpine/3.20/8.3/Dockerfile"
            tags: "8.3-alpine3.20"
            platforms: "linux/amd64"
          - image: "alpine/3.20/8.4/Dockerfile"
            tags: "8.4-alpine3.20"
            platforms: "linux/amd64"

          ### Alpine 3.21
          - image: "alpine/3.21/8.2/Dockerfile"
            tags: "8.2-alpine3.21"
            platforms: "linux/amd64"
          - image: "alpine/3.21/8.3/Dockerfile"
            tags: "8.3-alpine3.21"
            platforms: "linux/amd64"
          - image: "alpine/3.21/8.4/Dockerfile"
            tags: "8.4-alpine3.21"
            platforms: "linux/amd64"

          ### Alpine 3.22
          - image: "alpine/3.22/8.2/Dockerfile"
            tags: "8.2-alpine3.22"
            platforms: "linux/amd64"
          - image: "alpine/3.22/8.3/Dockerfile"
            tags: "8.3-alpine3.22"
            platforms: "linux/amd64"
          - image: "alpine/3.22/8.4/Dockerfile"
            tags: "8.4-alpine3.22"
            platforms: "linux/amd64"

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repo exists (scanOnPush on)
        run: |
          aws ecr describe-repositories --repository-names "${{ secrets.AWS_ECR_REPO }}" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "${{ secrets.AWS_ECR_REPO }}" \
            --image-scanning-configuration scanOnPush=true \
            --tags Key=ManagedBy,Value=GitHubActions

      - name: Resolve Docker Hub source & target tag from matrix
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_PATH="${{ matrix.image }}"
          ALPINE_VER="$(echo "$IMAGE_PATH" | awk -F/ '{print $2}')"
          PHP_VER="$(echo "$IMAGE_PATH"   | awk -F/ '{print $3}')"
          VARIANT="${PHP_VARIANT:-cli}"
          SOURCE="php:${PHP_VER}-${VARIANT}-alpine${ALPINE_VER}"
          if [[ -z "$ALPINE_VER" || -z "$PHP_VER" ]]; then
            echo "Bad matrix.image: $IMAGE_PATH"
            exit 1
          fi
          echo "source=$SOURCE" >> "$GITHUB_OUTPUT"
          echo "target_tag=${{ matrix.tags }}" >> "$GITHUB_OUTPUT"
          echo "platform=${{ matrix.platforms }}" >> "$GITHUB_OUTPUT"
          echo "Resolved SOURCE=$SOURCE; TARGET_TAG=${{ matrix.tags }}; PLATFORM=${{ matrix.platforms }}"

      - name: Pull from Docker Hub
        run: docker pull --platform "${{ steps.resolve.outputs.platform }}" "${{ steps.resolve.outputs.source }}"

      - name: Compute content digest + final tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ steps.resolve.outputs.source }}"
          DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "$REF" | awk -F@ '{print $2}')"
          if [[ -z "${DIGEST:-}" ]]; then
            echo "No digest for $REF"
            docker inspect "$REF" || true
            exit 1
          fi
          SHORT="${DIGEST#sha256:}"
          SHORT="${SHORT:0:12}"
          FINAL_TAG="${{ steps.resolve.outputs.target_tag }}-${SHORT}"
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "final_tag=$FINAL_TAG" >> "$GITHUB_OUTPUT"

      - name: Retag for ECR & push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ECR_URI="${ECR_REGISTRY}/${{ secrets.AWS_ECR_REPO }}:${{ steps.meta.outputs.final_tag }}"
          docker tag "${{ steps.resolve.outputs.source }}" "${ECR_URI}"
          docker push "${ECR_URI}"
          echo "ECR_URI=${ECR_URI}" >> $GITHUB_ENV

      - name: Scan Docker image (ECR)
        id: docker-scan
        uses: alexjurkiewicz/ecr-scan-image@v2.0.0
        with:
          repository: ${{ secrets.AWS_ECR_REPO }}
          tag: ${{ steps.meta.outputs.final_tag }}

      - name: Echo totals
        run: |
          echo "${{ steps.docker-scan.outputs.total }} total vulnerabilities."
          echo "Critical: ${{ steps.docker-scan.outputs.critical }}, High: ${{ steps.docker-scan.outputs.high }}, Medium: ${{ steps.docker-scan.outputs.medium }}, Low: ${{ steps.docker-scan.outputs.low }}"

      - name: Delete image from ECR (optional cleanup)
        if: always()
        run: |
          aws ecr batch-delete-image \
            --repository-name "${{ secrets.AWS_ECR_REPO }}" \
            --image-ids imageTag="${{ steps.meta.outputs.final_tag }}" || true

      - name: Set Date and Time
        id: set-date
        if: github.event_name == 'schedule'
        run: echo "current_datetime=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Set Color
        id: set-color
        if: github.event_name == 'schedule'
        shell: bash
        run: |
          if [ "${{ steps.docker-scan.outputs.total }}" = "0" ]; then
            echo "color=#008000" >> $GITHUB_OUTPUT
          else
            echo "color=#ff0000" >> $GITHUB_OUTPUT
          fi

      - name: Send GitHub Action trigger data to Slack
        id: slack
        if: github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Scanned image *${{ steps.resolve.outputs.source }}* â†’ *${{ secrets.AWS_ECR_REPO }}:${{ steps.meta.outputs.final_tag }}*",
              "attachments": [
                {
                  "pretext": "ECR vulnerability scan for ${{ steps.set-date.outputs.current_datetime }}",
                  "color": "${{ steps.set-color.outputs.color }}",
                  "fields": [
                    { "title": "Total",     "short": true, "value": "*${{ steps.docker-scan.outputs.total }}*" },
                    { "title": "Critical",  "short": true, "value": "${{ steps.docker-scan.outputs.critical }}" },
                    { "title": "High",      "short": true, "value": "${{ steps.docker-scan.outputs.high }}" },
                    { "title": "Medium",    "short": true, "value": "${{ steps.docker-scan.outputs.medium }}" },
                    { "title": "Low",       "short": true, "value": "${{ steps.docker-scan.outputs.low }}" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Fail the execution if vulns found
        if: ${{ steps.docker-scan.outputs.total && steps.docker-scan.outputs.total != '0' }}
        run: exit 1
