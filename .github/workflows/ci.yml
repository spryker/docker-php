name: CI/CD PHP Build and Scan

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-scan-images-for-vulnerabilities:
    strategy:
      fail-fast: false
      matrix:
        include:
          ## Alpine
          ### Alpine 3.18
          - image: "alpine/3.18/8.1/Dockerfile"
            tag: "spryker/php:8.1-alpine3.18"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.18/8.2/Dockerfile"
            tag: "spryker/php:8.2-alpine3.18"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.18/8.3/Dockerfile"
            tag: "spryker/php:8.3-alpine3.18"
            platforms: "linux/amd64,linux/arm64"

          ### Alpine 3.19
          - image: "alpine/3.19/8.1/Dockerfile"
            tag: "spryker/php:8.1-alpine3.19"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.19/8.2/Dockerfile"
            tag: "spryker/php:8.2-alpine3.19"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.19/8.3/Dockerfile"
            tag: "spryker/php:8.3-alpine3.19"
            platforms: "linux/amd64,linux/arm64"

          ### Alpine 3.20
          - image: "alpine/3.20/8.1/Dockerfile"
            tag: "spryker/php:8.1-alpine3.20"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.20/8.2/Dockerfile"
            tag: "spryker/php:8.2-alpine3.20"
            platforms: "linux/amd64,linux/arm64"
          - image: "alpine/3.20/8.3/Dockerfile"
            tag: "spryker/php:8.3-alpine3.20"
            platforms: "linux/amd64,linux/arm64"

          ## Debian
          ### Debian bullseye
          - image: "debian/bullseye/8.0/Dockerfile"
            tag: "spryker/php:8.0-debian"
            platforms: "linux/amd64,linux/arm64"
          - image: "debian/bullseye/8.1/Dockerfile"
            tag: "spryker/php:8.1-debian"
            platforms: "linux/amd64,linux/arm64"
          - image: "debian/bullseye/8.2/Dockerfile"
            tag: "spryker/php:8.2-debian"
            platforms: "linux/amd64,linux/arm64"
          - image: "debian/bullseye/8.3/Dockerfile"
            tag: "spryker/php:8.3-debian"
            platforms: "linux/amd64,linux/arm64"

    name: Build and Scan - ${{ matrix.tag }}
    uses: spryker-projects/gha-reusable-workflows/.github/workflows/ci.yml@main
    with:
      image: ${{ matrix.image }}
      tag: ${{ matrix.tag }}
      platforms: ${{ matrix.platforms }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CE_RELEASE_WEBHOOK }}
