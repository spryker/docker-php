name: PR Linter

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-pr-body:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Release Notes sections
        shell: bash
        run: |
          # Write PR body to file using heredoc to preserve formatting
          cat << 'EOF' > pr_body.txt
          ${{ github.event.pull_request.body }}
          EOF
          
          # Check for the mandatory 'Improvements' section
          if ! grep -F "### Improvements" pr_body.txt; then
            echo "Error: '### Improvements' section is missing in the PR body."
            exit 1
          fi

          # Conditionally check the 'Security Fixes' section
          if grep -F "### Security Fixes" pr_body.txt; then
            echo "Found 'Security Fixes' section. Verifying content..."
            # If the section exists, it MUST contain a CVE reference.
            if ! grep -F "CVE-" pr_body.txt; then
              echo "Error: '### Security Fixes' section exists but does not contain a CVE identifier (e.g., CVE-2025-1234)."
              exit 1
            fi
            echo "✅ Security Fixes section is valid."
          else
            echo "✅ No 'Security Fixes' section found. Skipping CVE check."
          fi
          
          echo "✅ PR body format is correct."